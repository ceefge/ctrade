@page "/configuration"
@using CTrader.Data.Entities
@using CTrader.Services.Configuration
@inject IParameterService ParameterService
@inject IConfiguration AppConfig
@inject IWebHostEnvironment Environment

<PageTitle>Konfiguration - CTrader</PageTitle>

<h1>Konfiguration</h1>

<!-- API Keys Section -->
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">API Keys</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label"><strong>Anthropic API Key</strong> (Claude LLM)</label>
                    <div class="input-group">
                        <input type="@(_showAnthropicKey ? "text" : "password")"
                               class="form-control"
                               @bind="_anthropicApiKey"
                               placeholder="sk-ant-..." />
                        <button class="btn btn-outline-secondary" type="button" @onclick="() => _showAnthropicKey = !_showAnthropicKey">
                            @(_showAnthropicKey ? "Verbergen" : "Anzeigen")
                        </button>
                    </div>
                    <small class="text-muted">Für Marktregime-Analyse und AI-Funktionen</small>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label"><strong>Finnhub API Key</strong></label>
                    <div class="input-group">
                        <input type="@(_showFinnhubKey ? "text" : "password")"
                               class="form-control"
                               @bind="_finnhubApiKey"
                               placeholder="Finnhub API Key..." />
                        <button class="btn btn-outline-secondary" type="button" @onclick="() => _showFinnhubKey = !_showFinnhubKey">
                            @(_showFinnhubKey ? "Verbergen" : "Anzeigen")
                        </button>
                    </div>
                    <small class="text-muted">Für Marktnachrichten (finnhub.io)</small>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label"><strong>Alpha Vantage API Key</strong></label>
                    <div class="input-group">
                        <input type="@(_showAlphaVantageKey ? "text" : "password")"
                               class="form-control"
                               @bind="_alphaVantageApiKey"
                               placeholder="Alpha Vantage API Key..." />
                        <button class="btn btn-outline-secondary" type="button" @onclick="() => _showAlphaVantageKey = !_showAlphaVantageKey">
                            @(_showAlphaVantageKey ? "Verbergen" : "Anzeigen")
                        </button>
                    </div>
                    <small class="text-muted">Für News und Sentiment-Daten</small>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label class="form-label"><strong>Interactive Brokers</strong> (Verbindung)</label>
                    <div class="input-group">
                        <input type="text" class="form-control" @bind="_ibGatewayHost" placeholder="Host (z.B. localhost)" />
                        <input type="number" class="form-control" style="max-width: 100px;" @bind="_ibGatewayPort" placeholder="Port" />
                    </div>
                    <small class="text-muted">IB Gateway Host und Port</small>
                </div>
            </div>
        </div>

        <hr class="my-4" />
        <h6 class="mb-3">IB Gateway Docker Credentials</h6>
        <div class="row">
            <div class="col-md-4">
                <div class="mb-3">
                    <label class="form-label"><strong>IB Username</strong></label>
                    <input type="text" class="form-control" @bind="_ibUsername" placeholder="IB Benutzername" />
                </div>
            </div>
            <div class="col-md-4">
                <div class="mb-3">
                    <label class="form-label"><strong>IB Password</strong></label>
                    <div class="input-group">
                        <input type="@(_showIbPassword ? "text" : "password")"
                               class="form-control"
                               @bind="_ibPassword"
                               placeholder="IB Passwort" />
                        <button class="btn btn-outline-secondary" type="button" @onclick="() => _showIbPassword = !_showIbPassword">
                            @(_showIbPassword ? "Verbergen" : "Anzeigen")
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="mb-3">
                    <label class="form-label"><strong>TOTP Secret</strong></label>
                    <div class="input-group">
                        <input type="@(_showTotpSecret ? "text" : "password")"
                               class="form-control"
                               @bind="_ibTotpSecret"
                               placeholder="2FA TOTP Secret (Base32)" />
                        <button class="btn btn-outline-secondary" type="button" @onclick="() => _showTotpSecret = !_showTotpSecret">
                            @(_showTotpSecret ? "Verbergen" : "Anzeigen")
                        </button>
                    </div>
                    <small class="text-muted">Für automatische 2FA-Anmeldung</small>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-4">
                <div class="mb-3">
                    <label class="form-label"><strong>VNC Passwort</strong></label>
                    <div class="input-group">
                        <input type="@(_showVncPassword ? "text" : "password")"
                               class="form-control"
                               @bind="_vncPassword"
                               placeholder="VNC Passwort" />
                        <button class="btn btn-outline-secondary" type="button" @onclick="() => _showVncPassword = !_showVncPassword">
                            @(_showVncPassword ? "Verbergen" : "Anzeigen")
                        </button>
                    </div>
                    <small class="text-muted">Für Remote-Zugriff auf IB Gateway</small>
                </div>
            </div>
            <div class="col-md-4">
                <div class="mb-3">
                    <label class="form-label"><strong>IB Gateway Fernzugriff</strong></label>
                    <div class="d-flex gap-2">
                        <a href="http://localhost:6081/vnc.html" target="_blank" class="btn btn-outline-info">
                            noVNC im Browser öffnen
                        </a>
                    </div>
                    <small class="text-muted">VNC-Passwort wird benötigt</small>
                </div>
            </div>
            <div class="col-md-4">
                <div class="mb-3">
                    <label class="form-label"><strong>IB Gateway Ports</strong></label>
                    <table class="table table-sm table-bordered mb-0" style="font-size: 0.85rem;">
                        <thead class="table-light">
                            <tr>
                                <th>Port</th>
                                <th>Modus</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="table-success">
                                <td><code>4001</code></td>
                                <td>Standard (Live / Paper)</td>
                            </tr>
                            <tr>
                                <td><code>4002</code></td>
                                <td>Paper Trading (alternativ)</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center">
            <button class="btn btn-primary" @onclick="SaveApiKeys" disabled="@_isSaving">
                @(_isSaving ? "Speichern..." : "Alle Einstellungen speichern")
            </button>
            @if (_saveMessage != null)
            {
                <span class="@(_saveSuccess ? "text-success" : "text-danger")">@_saveMessage</span>
            }
        </div>
    </div>
</div>

<!-- Parameters Section -->
<div class="row">
    <div class="col-md-3">
        <div class="card">
            <div class="card-header">Kategorien</div>
            <div class="list-group list-group-flush">
                @foreach (var category in _categories)
                {
                    <button class="list-group-item list-group-item-action @(category == _selectedCategory ? "active" : "")"
                            @onclick="() => SelectCategory(category)">
                        @category
                    </button>
                }
            </div>
        </div>
    </div>

    <div class="col-md-9">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>@(_selectedCategory ?? "Alle") Parameter</span>
                <button class="btn btn-sm btn-primary" @onclick="ShowAddModal">
                    Parameter hinzufügen
                </button>
            </div>
            <div class="card-body">
                @if (_parameters.Any())
                {
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Key</th>
                                <th>Wert</th>
                                <th>Typ</th>
                                <th>Beschreibung</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var param in _parameters)
                            {
                                <tr>
                                    <td><code>@param.Key</code></td>
                                    <td>
                                        @if (_editingParam?.Id == param.Id)
                                        {
                                            <input type="text" class="form-control form-control-sm" @bind="_editValue" />
                                        }
                                        else
                                        {
                                            <span class="@(param.DataType == "bool" ? (param.Value == "true" ? "text-success" : "text-danger") : "")">
                                                @TruncateValue(param.Value)
                                            </span>
                                        }
                                    </td>
                                    <td><span class="badge bg-secondary">@param.DataType</span></td>
                                    <td class="small text-muted">@param.Description</td>
                                    <td>
                                        @if (_editingParam?.Id == param.Id)
                                        {
                                            <button class="btn btn-sm btn-success" @onclick="SaveEdit">Speichern</button>
                                            <button class="btn btn-sm btn-secondary" @onclick="CancelEdit">Abbrechen</button>
                                        }
                                        else
                                        {
                                            <button class="btn btn-sm btn-outline-primary" @onclick="() => StartEdit(param)">Bearbeiten</button>
                                            <button class="btn btn-sm btn-outline-danger" @onclick="() => DeleteParameter(param)">Löschen</button>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <p class="text-muted">Keine Parameter in dieser Kategorie.</p>
                }
            </div>
        </div>
    </div>
</div>

@if (_showAddModal)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Parameter hinzufügen</h5>
                    <button type="button" class="btn-close" @onclick="HideAddModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Kategorie</label>
                        <input type="text" class="form-control" @bind="_newParam.Category" list="categories" />
                        <datalist id="categories">
                            @foreach (var cat in _categories)
                            {
                                <option value="@cat" />
                            }
                        </datalist>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Key</label>
                        <input type="text" class="form-control" @bind="_newParam.Key" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Wert</label>
                        <input type="text" class="form-control" @bind="_newParam.Value" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Datentyp</label>
                        <select class="form-select" @bind="_newParam.DataType">
                            <option value="string">string</option>
                            <option value="int">int</option>
                            <option value="decimal">decimal</option>
                            <option value="bool">bool</option>
                            <option value="json">json</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Beschreibung</label>
                        <input type="text" class="form-control" @bind="_newParam.Description" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="HideAddModal">Abbrechen</button>
                    <button type="button" class="btn btn-primary" @onclick="AddParameter">Hinzufügen</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    // API Keys
    private string _anthropicApiKey = "";
    private string _finnhubApiKey = "";
    private string _alphaVantageApiKey = "";
    private string _ibGatewayHost = "localhost";
    private int _ibGatewayPort = 4001;
    private string _ibUsername = "";
    private string _ibPassword = "";
    private string _ibTotpSecret = "";
    private string _vncPassword = "ctrader";
    private bool _showAnthropicKey;
    private bool _showFinnhubKey;
    private bool _showAlphaVantageKey;
    private bool _showIbPassword;
    private bool _showTotpSecret;
    private bool _showVncPassword;
    private bool _isSaving;
    private string? _saveMessage;
    private bool _saveSuccess;

    // Parameters
    private List<string> _categories = [];
    private List<Parameter> _parameters = [];
    private string? _selectedCategory;
    private Parameter? _editingParam;
    private string _editValue = "";
    private bool _showAddModal;
    private NewParameterModel _newParam = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadApiKeysAsync();
        await LoadCategoriesAsync();
        await LoadParametersAsync();
    }

    private async Task LoadApiKeysAsync()
    {
        // Load from database parameters
        _anthropicApiKey = await ParameterService.GetValueAsync("ApiKeys", "Anthropic", "");
        _finnhubApiKey = await ParameterService.GetValueAsync("ApiKeys", "Finnhub", "");
        _alphaVantageApiKey = await ParameterService.GetValueAsync("ApiKeys", "AlphaVantage", "");
        _ibGatewayHost = await ParameterService.GetValueAsync("ApiKeys", "IbGatewayHost", "localhost");
        _ibGatewayPort = await ParameterService.GetValueAsync("ApiKeys", "IbGatewayPort", 4001);
        _ibUsername = await ParameterService.GetValueAsync("ApiKeys", "IbUsername", "");
        _ibPassword = await ParameterService.GetValueAsync("ApiKeys", "IbPassword", "");
        _ibTotpSecret = await ParameterService.GetValueAsync("ApiKeys", "IbTotpSecret", "");
        _vncPassword = await ParameterService.GetValueAsync("ApiKeys", "VncPassword", "ctrader");

        // If not in DB, try to load from config
        if (string.IsNullOrEmpty(_anthropicApiKey))
            _anthropicApiKey = AppConfig["Anthropic:ApiKey"] ?? "";
        if (string.IsNullOrEmpty(_finnhubApiKey))
            _finnhubApiKey = AppConfig["Finnhub:ApiKey"] ?? "";
        if (string.IsNullOrEmpty(_alphaVantageApiKey))
            _alphaVantageApiKey = AppConfig["AlphaVantage:ApiKey"] ?? "";

        // Also try loading from .env file if exists
        await LoadFromEnvFileAsync();
    }

    private async Task LoadFromEnvFileAsync()
    {
        var envPath = GetEnvFilePath();
        if (!File.Exists(envPath)) return;

        try
        {
            var lines = await File.ReadAllLinesAsync(envPath);
            foreach (var line in lines)
            {
                if (string.IsNullOrWhiteSpace(line) || line.StartsWith('#')) continue;
                var parts = line.Split('=', 2);
                if (parts.Length != 2) continue;

                var key = parts[0].Trim();
                var value = parts[1].Trim();

                // Only load if not already set from DB
                switch (key)
                {
                    case "IB_USERNAME" when string.IsNullOrEmpty(_ibUsername):
                        _ibUsername = value;
                        break;
                    case "IB_PASSWORD" when string.IsNullOrEmpty(_ibPassword):
                        _ibPassword = value;
                        break;
                    case "IB_TOTP_SECRET" when string.IsNullOrEmpty(_ibTotpSecret):
                        _ibTotpSecret = value;
                        break;
                    case "ANTHROPIC_API_KEY" when string.IsNullOrEmpty(_anthropicApiKey):
                        _anthropicApiKey = value;
                        break;
                    case "FINNHUB_API_KEY" when string.IsNullOrEmpty(_finnhubApiKey):
                        _finnhubApiKey = value;
                        break;
                    case "ALPHA_VANTAGE_API_KEY" when string.IsNullOrEmpty(_alphaVantageApiKey):
                        _alphaVantageApiKey = value;
                        break;
                    case "VNC_PASSWORD" when string.IsNullOrEmpty(_vncPassword) || _vncPassword == "ctrader":
                        _vncPassword = value;
                        break;
                }
            }
        }
        catch
        {
            // Ignore errors reading .env file
        }
    }

    private string GetEnvFilePath()
    {
        // Go up from ContentRootPath to find the repo root with docker-compose.yml
        var path = Environment.ContentRootPath;
        while (!string.IsNullOrEmpty(path))
        {
            var envFile = Path.Combine(path, ".env");
            var dockerCompose = Path.Combine(path, "docker-compose.yml");
            if (File.Exists(dockerCompose))
                return envFile;
            path = Path.GetDirectoryName(path);
        }
        // Fallback to content root
        return Path.Combine(Environment.ContentRootPath, "..", "..", ".env");
    }

    private async Task SaveApiKeys()
    {
        _isSaving = true;
        _saveMessage = null;

        try
        {
            // Save to database
            await ParameterService.SetAsync("ApiKeys", "Anthropic", _anthropicApiKey, "string", "Anthropic Claude API Key");
            await ParameterService.SetAsync("ApiKeys", "Finnhub", _finnhubApiKey, "string", "Finnhub API Key");
            await ParameterService.SetAsync("ApiKeys", "AlphaVantage", _alphaVantageApiKey, "string", "Alpha Vantage API Key");
            await ParameterService.SetAsync("ApiKeys", "IbGatewayHost", _ibGatewayHost, "string", "IB Gateway Host");
            await ParameterService.SetAsync("ApiKeys", "IbGatewayPort", _ibGatewayPort, "int", "IB Gateway Port");
            await ParameterService.SetAsync("ApiKeys", "IbUsername", _ibUsername, "string", "IB Gateway Username");
            await ParameterService.SetAsync("ApiKeys", "IbPassword", _ibPassword, "string", "IB Gateway Password");
            await ParameterService.SetAsync("ApiKeys", "IbTotpSecret", _ibTotpSecret, "string", "IB Gateway TOTP Secret");
            await ParameterService.SetAsync("ApiKeys", "VncPassword", _vncPassword, "string", "VNC Password für IB Gateway");

            // Write .env file for Docker
            await WriteEnvFileAsync();

            _saveMessage = "Einstellungen gespeichert! .env Datei aktualisiert.";
            _saveSuccess = true;
            await LoadCategoriesAsync();
        }
        catch (Exception ex)
        {
            _saveMessage = $"Fehler: {ex.Message}";
            _saveSuccess = false;
        }
        finally
        {
            _isSaving = false;
        }
    }

    private async Task WriteEnvFileAsync()
    {
        var envPath = GetEnvFilePath();
        var lines = new[]
        {
            "# CTrader Docker Environment Variables",
            "# Generated by CTrader Configuration",
            "",
            "# Interactive Brokers Gateway",
            $"IB_USERNAME={_ibUsername}",
            $"IB_PASSWORD={_ibPassword}",
            $"IB_TOTP_SECRET={_ibTotpSecret}",
            $"VNC_PASSWORD={_vncPassword}",
            "",
            "# API Keys",
            $"ANTHROPIC_API_KEY={_anthropicApiKey}",
            $"FINNHUB_API_KEY={_finnhubApiKey}",
            $"ALPHA_VANTAGE_API_KEY={_alphaVantageApiKey}"
        };

        await File.WriteAllLinesAsync(envPath, lines);
    }

    private async Task LoadCategoriesAsync()
    {
        _categories = (await ParameterService.GetCategoriesAsync()).ToList();
    }

    private async Task LoadParametersAsync()
    {
        if (string.IsNullOrEmpty(_selectedCategory))
        {
            _parameters = (await ParameterService.GetAllAsync()).ToList();
        }
        else
        {
            _parameters = (await ParameterService.GetByCategoryAsync(_selectedCategory)).ToList();
        }
    }

    private async Task SelectCategory(string category)
    {
        _selectedCategory = _selectedCategory == category ? null : category;
        await LoadParametersAsync();
    }

    private void StartEdit(Parameter param)
    {
        _editingParam = param;
        _editValue = param.Value;
    }

    private void CancelEdit()
    {
        _editingParam = null;
        _editValue = "";
    }

    private async Task SaveEdit()
    {
        if (_editingParam != null)
        {
            await ParameterService.SetAsync(_editingParam.Category, _editingParam.Key, _editValue, _editingParam.DataType, _editingParam.Description);
            await LoadParametersAsync();
            CancelEdit();
        }
    }

    private async Task DeleteParameter(Parameter param)
    {
        await ParameterService.DeleteAsync(param.Category, param.Key);
        await LoadParametersAsync();
    }

    private void ShowAddModal()
    {
        _newParam = new NewParameterModel { Category = _selectedCategory ?? "Trading", DataType = "string" };
        _showAddModal = true;
    }

    private void HideAddModal()
    {
        _showAddModal = false;
    }

    private async Task AddParameter()
    {
        if (!string.IsNullOrEmpty(_newParam.Category) && !string.IsNullOrEmpty(_newParam.Key))
        {
            await ParameterService.SetAsync(_newParam.Category, _newParam.Key, _newParam.Value ?? "", _newParam.DataType ?? "string", _newParam.Description);
            await LoadCategoriesAsync();
            await LoadParametersAsync();
            HideAddModal();
        }
    }

    private static string TruncateValue(string value)
    {
        return value.Length > 50 ? value[..47] + "..." : value;
    }

    private class NewParameterModel
    {
        public string Category { get; set; } = "";
        public string Key { get; set; } = "";
        public string? Value { get; set; }
        public string? DataType { get; set; }
        public string? Description { get; set; }
    }
}
