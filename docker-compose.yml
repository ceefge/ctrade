services:
  ib-gateway:
    image: ghcr.io/gnzsnz/ib-gateway:stable
    restart: unless-stopped
    environment:
      TWS_USERID: ${IB_USERNAME}
      TWS_PASSWORD: ${IB_PASSWORD}
      TRADING_MODE: paper
      TWS_ACCEPT_INCOMING: "yes"
      TWOFA_TIMEOUT_ACTION: restart
      IBC_TOTP_SECRET: ${IB_TOTP_SECRET}
      VNC_SERVER: "yes"
      VNC_SERVER_PASSWORD: ${VNC_PASSWORD:-ctrader}
    ports:
      - "5901:5900"
    volumes:
      - ib-gateway-data:/home/ibgateway
    networks:
      - ctrader-network

  novnc:
    image: theasp/novnc:latest
    restart: unless-stopped
    depends_on:
      - ib-gateway
    environment:
      DISPLAY_WIDTH: 1280
      DISPLAY_HEIGHT: 800
      RUN_XTERM: "no"
      REMOTE_HOST: ib-gateway
      REMOTE_PORT: 5900
    ports:
      - "6080:8080"
    networks:
      - ctrader-network

  ctrader:
    build:
      context: ./src/CTrader
      dockerfile: Dockerfile
    restart: unless-stopped
    depends_on:
      - ib-gateway
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__Default=Data Source=/app/data/ctrader.db
      - IbGateway__Host=ib-gateway
      - IbGateway__Port=4002
      - Finnhub__ApiKey=${FINNHUB_API_KEY}
      - AlphaVantage__ApiKey=${ALPHA_VANTAGE_API_KEY}
      - Anthropic__ApiKey=${ANTHROPIC_API_KEY}
    ports:
      - "8080:8080"
    volumes:
      - ctrader-data:/app/data
    networks:
      - ctrader-network

volumes:
  ib-gateway-data:
  ctrader-data:

networks:
  ctrader-network:
    driver: bridge
